import numpy as np

from stixcore.calibration.ecc_post_fit import ecc_post_fit_on_fits
from stixcore.data.test import test_data


def test_ecc_post_fit():
    erg_path = test_data.ecc.ecc_post_fit_erg_fits
    para_path = test_data.ecc.ecc_post_fit_para_fits
    livetime = 17514.111

    ecc_pf_df, idx_ecc = ecc_post_fit_on_fits(erg_path, para_path, livetime)
    assert len(ecc_pf_df) == 32 * 12

    # this means that all pixels were replaced with the post fit values
    assert idx_ecc.sum() == 0

    assert len(idx_ecc) == 32 * 12

    res_off = np.array(
        [
            224.04619648,
            224.96505813,
            224.18294085,
            224.62472568,
            222.37226822,
            225.17209107,
            224.26870091,
            222.43660962,
            223.11425513,
            225.59242914,
            225.37479607,
            221.97007337,
            219.68842845,
            223.27160178,
            222.82731152,
            222.15705263,
            219.44921769,
            222.4044885,
            225.20887115,
            222.02917395,
            220.77905378,
            219.95256765,
            223.44940418,
            222.55543108,
            224.09058425,
            223.00613439,
            223.95972231,
            224.09227324,
            224.38641196,
            226.1475199,
            222.93310605,
            225.17732552,
            221.27653681,
            219.52707064,
            224.3000177,
            225.8067732,
            218.2232081,
            218.73849064,
            221.92276834,
            221.69646935,
            219.74207724,
            223.81545746,
            220.45560307,
            220.59857727,
            217.9435415,
            219.88509266,
            221.94531796,
            218.21901056,
            227.36434827,
            227.50476961,
            228.95170007,
            225.46918644,
            227.20494912,
            228.10391767,
            226.33629332,
            228.41357057,
            226.65278366,
            227.67819281,
            228.17070411,
            226.77056013,
            226.29414055,
            225.47076172,
            226.2710587,
            225.42249949,
            227.04583138,
            223.69508646,
            226.03425999,
            226.85956561,
            224.32514764,
            224.50826573,
            224.26560095,
            223.56551132,
            230.75975564,
            227.78657385,
            229.16486158,
            226.77108543,
            226.81191844,
            228.13728928,
            226.74660684,
            228.70098851,
            228.40028951,
            228.66260961,
            228.16990037,
            226.87375888,
            225.56969285,
            224.62995739,
            227.98327564,
            226.43641448,
            221.40277869,
            222.69575992,
            223.88021838,
            225.03737207,
            224.16714268,
            223.59073091,
            224.04275879,
            225.37569347,
            224.87924831,
            223.419326,
            224.00559995,
            224.79874025,
            227.39575781,
            226.98353542,
            221.62154967,
            224.06502575,
            222.57926311,
            227.16087771,
            224.67181593,
            222.52623726,
            222.76639135,
            222.38324641,
            222.76845695,
            222.70363439,
            223.11309242,
            222.8071044,
            223.30657533,
            222.38846811,
            220.12574404,
            223.84352711,
            221.48373483,
            221.37667916,
            229.29550512,
            230.27062936,
            228.66081671,
            227.96884635,
            228.73071916,
            227.72370869,
            231.04295636,
            227.54084045,
            225.73158419,
            229.91674114,
            224.55000862,
            232.71290756,
            226.87223422,
            231.25901212,
            228.31493601,
            229.19469149,
            229.72088911,
            226.68068878,
            226.94613023,
            228.56032523,
            227.05469362,
            227.60718262,
            229.59349671,
            229.62207751,
            231.47094785,
            230.5069234,
            230.4050039,
            232.31460111,
            233.24368014,
            228.76025929,
            232.30889371,
            231.76583866,
            233.16704822,
            230.26219695,
            229.38366165,
            231.25581665,
            223.40982251,
            219.52625837,
            221.11697962,
            223.46495316,
            221.04798744,
            220.41628164,
            223.16625017,
            221.67195595,
            224.59944915,
            225.10280414,
            220.69911409,
            219.8555955,
            219.39880577,
            220.50548215,
            220.92824186,
            218.2705591,
            219.5538419,
            218.93761676,
            220.6017263,
            220.32783162,
            218.04754274,
            219.81116401,
            216.34076251,
            218.92948347,
            225.00072022,
            226.17383786,
            225.86862408,
            226.4341798,
            223.72413055,
            224.3471273,
            227.8265652,
            225.47863229,
            228.41861909,
            228.44864599,
            225.59930667,
            225.35400058,
            227.30042907,
            226.99821381,
            223.0616907,
            227.34500621,
            228.14273116,
            228.93629524,
            226.34712869,
            227.2313015,
            228.32505983,
            227.11771677,
            227.67521067,
            229.34858455,
            230.03057759,
            231.39840362,
            231.57520529,
            232.60893363,
            230.23837315,
            227.65501668,
            230.92368566,
            230.10071999,
            231.61816167,
            229.05547651,
            228.64368517,
            229.05493284,
            230.32128999,
            226.4833258,
            229.94812474,
            228.51532463,
            224.61063057,
            226.78329044,
            228.98190365,
            228.96542149,
            227.66354097,
            225.80519619,
            228.26547706,
            226.00542599,
            229.56177832,
            232.9095339,
            227.07403517,
            229.4774744,
            228.82165355,
            231.23790225,
            233.13031986,
            228.69008509,
            231.98256798,
            228.23153231,
            230.57369718,
            228.45485386,
            224.49232237,
            224.23887497,
            224.96824108,
            222.78785776,
            221.33183952,
            226.73817403,
            225.08846383,
            224.99639839,
            226.1760246,
            223.86332103,
            226.17024763,
            223.72118317,
            220.99746018,
            222.52586955,
            223.71805717,
            223.50705549,
            220.99616611,
            222.92548042,
            222.80638014,
            223.51541852,
            220.23219601,
            224.10582119,
            222.23346931,
            222.51771965,
            229.86082894,
            229.39360356,
            228.3442988,
            229.50970932,
            229.83007675,
            230.96836295,
            232.56218437,
            231.12405547,
            229.33393726,
            231.09188007,
            230.11130682,
            228.94825673,
            230.08350725,
            226.65880816,
            229.90255617,
            230.10587329,
            229.96817036,
            229.31917825,
            230.89151111,
            229.56620534,
            231.76277764,
            233.3121906,
            228.89403287,
            229.60250684,
            229.09469433,
            226.67268692,
            228.40822698,
            226.27639448,
            226.21472343,
            224.70683217,
            225.41288945,
            228.06500722,
            228.14865444,
            230.05274399,
            225.36332622,
            228.21422804,
            224.33868225,
            223.17406528,
            225.28568529,
            222.94976292,
            225.4066228,
            224.20481182,
            224.56669202,
            222.28281173,
            219.49126144,
            222.76765102,
            221.06305402,
            220.81538957,
            226.46573041,
            224.13082473,
            224.36829669,
            224.14801246,
            223.82504368,
            223.90637071,
            221.94290335,
            224.61031325,
            226.19091213,
            222.41603291,
            226.11220631,
            225.63885726,
            223.59218269,
            224.2562346,
            224.83981458,
            223.76682053,
            225.58419144,
            225.44890023,
            225.69826825,
            227.29106783,
            225.4900708,
            224.30867628,
            224.40590969,
            224.59897305,
            229.47583282,
            227.7632603,
            227.68184252,
            225.49693968,
            225.05079198,
            226.91024716,
            228.14538139,
            226.20757735,
            227.79813383,
            224.96006793,
            223.58557119,
            226.29073655,
            223.10515498,
            224.33998862,
            224.13941316,
            225.88764965,
            224.51512946,
            227.28265615,
            222.13987961,
            227.73206389,
            224.5296642,
            225.24584193,
            226.85426335,
            224.58346747,
            217.14786628,
            214.18842734,
            217.68445082,
            215.62140388,
            217.44106947,
            215.32785349,
            215.40881955,
            218.93041174,
            217.08342858,
            218.22715107,
            216.05229795,
            219.80453235,
            222.66507647,
            223.72005729,
            225.0686172,
            222.19684815,
            224.36055351,
            224.12570907,
            220.69296278,
            220.44827884,
            219.24859474,
            221.36904506,
            218.60885651,
            223.78501128,
        ]
    )
    res_gain = np.array(
        [
            2.27575919,
            2.26635084,
            2.27377539,
            2.25516507,
            2.26204935,
            2.24693344,
            2.28959595,
            2.26388257,
            2.27110539,
            2.26524267,
            2.27130813,
            2.25655203,
            2.29594563,
            2.26310714,
            2.27639603,
            2.29577322,
            2.2879465,
            2.29632594,
            2.27478998,
            2.28423931,
            2.30639195,
            2.28053642,
            2.28418921,
            2.25889384,
            2.2996061,
            2.30042396,
            2.2869008,
            2.30845157,
            2.31381177,
            2.30249537,
            2.31441452,
            2.30915305,
            2.30828634,
            2.33852822,
            2.3112443,
            2.30666588,
            2.30865071,
            2.30613873,
            2.30471273,
            2.29005227,
            2.32440294,
            2.29243659,
            2.30492788,
            2.29756391,
            2.32779229,
            2.33208362,
            2.31522169,
            2.28915137,
            2.26087019,
            2.26513542,
            2.25674774,
            2.28820072,
            2.28184075,
            2.26938805,
            2.25734219,
            2.27265143,
            2.26669609,
            2.27200491,
            2.27307619,
            2.28140435,
            2.27715221,
            2.2389204,
            2.25243531,
            2.26486346,
            2.26854567,
            2.24956876,
            2.26431656,
            2.28207353,
            2.26126925,
            2.25574309,
            2.27448074,
            2.25887788,
            2.29848791,
            2.2684154,
            2.29183083,
            2.28865904,
            2.29337225,
            2.27026679,
            2.24260948,
            2.29942729,
            2.30086241,
            2.27944932,
            2.28063493,
            2.30437871,
            2.29148152,
            2.307492,
            2.30451423,
            2.29771166,
            2.33047401,
            2.32101699,
            2.30771545,
            2.30882763,
            2.30676193,
            2.30117084,
            2.31140317,
            2.29769428,
            2.31523688,
            2.30989503,
            2.31190339,
            2.30629955,
            2.3302094,
            2.3026628,
            2.32252723,
            2.33442813,
            2.3089963,
            2.29064182,
            2.2957219,
            2.32376125,
            2.29510065,
            2.31338069,
            2.3097989,
            2.28670811,
            2.29330691,
            2.28850475,
            2.30183274,
            2.2950721,
            2.28636384,
            2.28041737,
            2.2856637,
            2.28586625,
            2.29085314,
            2.29088662,
            2.28302327,
            2.28944686,
            2.30386332,
            2.28081932,
            2.27683785,
            2.29923322,
            2.3055153,
            2.28190995,
            2.29386785,
            2.3151107,
            2.28634508,
            2.27669849,
            2.26677199,
            2.28053636,
            2.28677128,
            2.29217865,
            2.26830544,
            2.28138959,
            2.31157895,
            2.28396476,
            2.2619342,
            2.25480635,
            2.28529274,
            2.28283731,
            2.28885591,
            2.28696172,
            2.30208527,
            2.26558027,
            2.2808772,
            2.29718495,
            2.30020053,
            2.31430952,
            2.30171535,
            2.29617972,
            2.34778014,
            2.33852223,
            2.3429078,
            2.33970639,
            2.34365939,
            2.32654188,
            2.30301709,
            2.35377512,
            2.35352546,
            2.34831617,
            2.35694573,
            2.33843867,
            2.33091638,
            2.32269795,
            2.32357532,
            2.33441056,
            2.33991268,
            2.33216116,
            2.3498761,
            2.34119482,
            2.34314536,
            2.29181664,
            2.34198445,
            2.34200237,
            2.2904988,
            2.26784767,
            2.24953772,
            2.26411819,
            2.26537144,
            2.26824539,
            2.26393289,
            2.26147682,
            2.25593381,
            2.25999971,
            2.29005831,
            2.28024436,
            2.25365394,
            2.26676288,
            2.24303291,
            2.27074994,
            2.26881279,
            2.24377397,
            2.2476212,
            2.26788002,
            2.2655236,
            2.24430976,
            2.25858825,
            2.23788055,
            2.26815423,
            2.25018677,
            2.27039132,
            2.28170714,
            2.28046064,
            2.24727838,
            2.26852706,
            2.26736781,
            2.27246495,
            2.25729868,
            2.2681651,
            2.26367226,
            2.30256123,
            2.32785652,
            2.31405882,
            2.31012274,
            2.32272127,
            2.31673955,
            2.31627841,
            2.33037653,
            2.33067992,
            2.31687098,
            2.33252992,
            2.31239435,
            2.29471796,
            2.29125015,
            2.27760071,
            2.29584633,
            2.28002589,
            2.2935521,
            2.28897299,
            2.30588081,
            2.3104993,
            2.29298,
            2.29002409,
            2.2730579,
            2.30079067,
            2.31934901,
            2.29956709,
            2.300834,
            2.29919151,
            2.30558302,
            2.29044055,
            2.30565575,
            2.29397426,
            2.31461998,
            2.310687,
            2.29538546,
            2.29031383,
            2.29366704,
            2.29962691,
            2.31289243,
            2.30369966,
            2.28743265,
            2.30090379,
            2.29827966,
            2.27013692,
            2.29577215,
            2.29695949,
            2.29685538,
            2.2947704,
            2.28656025,
            2.28797871,
            2.28427826,
            2.30408409,
            2.28001096,
            2.28629296,
            2.31148999,
            2.29314124,
            2.28987844,
            2.29857307,
            2.27954082,
            2.26889198,
            2.27883798,
            2.27563296,
            2.2805131,
            2.27989726,
            2.27346332,
            2.26682509,
            2.28661253,
            2.26561532,
            2.29651403,
            2.27954729,
            2.2558438,
            2.28049248,
            2.27517843,
            2.27059846,
            2.28514457,
            2.28012452,
            2.27629156,
            2.27187198,
            2.27117667,
            2.28636166,
            2.29931289,
            2.31732337,
            2.26090976,
            2.32731603,
            2.312435,
            2.29885813,
            2.32892797,
            2.32325849,
            2.33902257,
            2.31967165,
            2.33524957,
            2.34980527,
            2.33970117,
            2.33624399,
            2.34989225,
            2.2821954,
            2.30050512,
            2.27852411,
            2.28771747,
            2.28030535,
            2.27943136,
            2.28560994,
            2.29504653,
            2.29641788,
            2.29073511,
            2.2702031,
            2.25100871,
            2.30342556,
            2.28322797,
            2.28888951,
            2.28910629,
            2.277025,
            2.28553241,
            2.28265435,
            2.29938891,
            2.28669191,
            2.29109907,
            2.26350703,
            2.27462465,
            2.30589994,
            2.31859421,
            2.27643891,
            2.29255116,
            2.30369483,
            2.30458429,
            2.2942174,
            2.31498913,
            2.31700124,
            2.31446552,
            2.3018406,
            2.31176022,
            2.30959244,
            2.30063931,
            2.30206968,
            2.28690347,
            2.30197799,
            2.27669885,
            2.28955543,
            2.3040898,
            2.31699292,
            2.28561151,
            2.27729542,
            2.28444514,
            2.28531326,
            2.30361535,
            2.30485364,
            2.3265916,
            2.29404568,
            2.29989055,
            2.29628459,
            2.31894395,
            2.31711239,
            2.29972877,
            2.30150044,
            2.28946111,
            2.27739759,
            2.29228114,
            2.28978524,
            2.30362546,
            2.30272171,
            2.30092037,
            2.3086411,
            2.32326096,
            2.34546249,
            2.28797657,
            2.29586401,
            2.31881827,
        ]
    )

    assert np.allclose(res_off, ecc_pf_df.Offset_Cor.values)
    assert np.allclose(res_gain, ecc_pf_df.Gain_Cor.values)
